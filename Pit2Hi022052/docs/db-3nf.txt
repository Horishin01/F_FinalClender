# 現行DB（第3正規形の整理）※EF Coreモデル準拠

ApplicationDbContextがマップしているテーブル（Identity標準を含む）を、第3正規形で整理。キーは行を一意にし、非キー属性は主キーのみに関数従属する。

Table: AspNetUsers (ApplicationUser)
- PK: Id (string)
- Columns（Identity標準一式）: UserName, NormalizedUserName, Email, NormalizedEmail, EmailConfirmed, PasswordHash, SecurityStamp, ConcurrencyStamp, PhoneNumber, PhoneNumberConfirmed, TwoFactorEnabled, LockoutEnd, LockoutEnabled, AccessFailedCount
- 備考: Identityの関連（AspNetUserRoles, AspNetRoles, 各種claims/logins/tokens）は標準。全ての属性はユーザーを表し、Idに従属。

Table: Events
- PK: Id (string)
- Columns: UserId (FK -> AspNetUsers.Id), UID, Title, StartDate (null可), EndDate (null可), LastModified (null可), Description, AllDay (bool), Source (enum), Category (enum), Priority (enum), Location (nullable), AttendeesCsv (nullable), Recurrence (enum), ReminderMinutesBefore (nullable int)
- 従属関係: Id -> 全カラム。UIDは外部同期用識別子で他属性から決まらない。`IsAllDay` は NotMapped（DB非格納）。

Table: ICCards
- PK: Id (string)
- Columns: UserId (FK -> AspNetUsers.Id), Uid (ICカードUID)
- 従属関係: Id -> 全カラム。Uidはカード固有値で他属性から決まらない。

Table: ICloudSettings
- PK: Id (string, Guid文字列)
- Columns: UserId (FK -> AspNetUsers.Id), Username (Apple IDメール), Password (アプリアクセス用パスワード)
- 従属関係: Id -> 全カラム。資格情報はこの行のみに帰属。

Note: Personalモデルは削除された（DbContext未登録）

ER図（テキスト例）※AspNetUsers起点で1対1/1対多を明示（ユーザーを上に配置）

┌─────────────────┐
│   AspNetUsers   │
│   ● Id (PK)     │
│   ...Identity...│
└──────┬──────────┬──────────┬──────────┐
       │0..1       │0..1       │0..*       │
       │           │           │           │
┌──────▼─────┐ ┌──▼────────┐ ┌──────────▼─────────┐
│ICloudSettings│ │ ICCards   │   │ Events             │
│○ UserId      │ │○ UserId   │   │○ UserId            │
│Username      │ │Uid        │   │UID                 │
│Password      │ └───────────┘   │Title               │
└──────────────┘ ※ICCardsは1対1  │StartDate          │
（モデルにUnique未設定）           │EndDate            │
                                 │LastModified       │
                                 │Description        │
                                 │AllDay             │
                                 │Source/Category    │
                                 │Priority/Location  │
                                 │Attendees/Recurr.  │
                                 │ReminderMinutes    │
                                 └───────────────────┘

セキュリティ前提メモ（公開時想定）
- ICloudSettings: 認証情報は平文保存しない。暗号化ストア/Key Vault等を前提に設計し、可能なら保存自体を最小化（トークンのみ保存）する。
- ICCards: 1対1を仕様にするならUserIdへUnique制約を付け、マイグレーションを適用する。
- 監査・削除: 機微情報にはアクセス監査ログと論理削除ポリシーを導入すること。
- 文書運用: DBスキーマ更新時は本ファイルも必ず同期更新する（公開前は現行RDBを軸に記載）。

セキュリティ想定時のER図（テキスト例）
┌──────────────────┐
│   AspNetUsers    │
│   ● Id (PK)      │ 1
│   ...Identity... │
└──────┬───────────┬───────────┬────────────┐
       │0..1(Unique)│0..1(Unique)│0..*        │
       │            │            │            │
┌──────▼──────────┐┌──────────▼────────┐┌───────────▼─────────┐
│ICloudSettings   ││     ICCards        ││       Events        │
│○ UserId (UQ)    ││ ○ UserId (UQ)      ││ ○ UserId            │
│Username (secure)││ Uid (IC UID)       ││ UID (external sync) │
│Password (secure)│└────────────────────┘│ Title               │
└─────────────────┘                      │ StartDate           │
                                         │ EndDate             │
                                         │ LastModified        │
                                         │ Description         │
                                         │ AllDay              │
                                         │ Source/Category     │
                                         │ Priority/Location   │
                                         │ Attendees/Recurr.   │
                                         │ ReminderMinutes     │
                                         └─────────────────────┘
