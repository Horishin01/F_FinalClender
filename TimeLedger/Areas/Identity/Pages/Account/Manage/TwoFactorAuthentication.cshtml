@page
@using Microsoft.AspNetCore.Http.Features
@model TwoFactorAuthenticationModel
@{
    ViewData["Title"] = "2段階認証";
    ViewData["ActivePage"] = ManageNavPages.TwoFactorAuthentication;
}

<div class="settings-card">
    <h2>@ViewData["Title"]</h2>
    <p class="settings-description">Authenticator アプリやバックアップコードを利用して、アカウントをさらに安全に守ります。</p>

    <partial name="_StatusMessage" for="StatusMessage" />

    @{
        var consentFeature = HttpContext.Features.Get<ITrackingConsentFeature>();
        if (!(consentFeature?.CanTrack ?? true))
        {
            <div class="danger-zone">
                <strong>プライバシーポリシーに未同意です。</strong>
                <p>2段階認証を利用する前に、クッキー利用への同意が必要です。</p>
            </div>
        }
        else
        {
            if (Model.Is2faEnabled)
            {
                if (Model.RecoveryCodesLeft == 0)
                {
                    <div class="danger-zone">
                        <strong>バックアップコードが残っていません。</strong>
                        <p><a asp-page="./GenerateRecoveryCodes">新しいバックアップコードを生成</a>してからご利用ください。</p>
                    </div>
                }
                else if (Model.RecoveryCodesLeft == 1)
                {
                    <div class="danger-zone">
                        <strong>残り 1 枚です。</strong>
                        <p>お早めに <a asp-page="./GenerateRecoveryCodes">新しいコードを生成</a>してください。</p>
                    </div>
                }
                else if (Model.RecoveryCodesLeft <= 3)
                {
                    <div class="danger-zone">
                        <strong>残り @Model.RecoveryCodesLeft 枚です。</strong>
                        <p>安全のため、<a asp-page="./GenerateRecoveryCodes">コードを更新</a>しましょう。</p>
                    </div>
                }

                <div class="form-actions">
                    @if (Model.IsMachineRemembered)
                    {
                        <form method="post" class="d-inline">
                            <button type="submit" class="btn-outline">このブラウザーを忘れる</button>
                        </form>
                    }
                    <a asp-page="./Disable2fa" class="btn-outline">2段階認証を無効にする</a>
                    <a asp-page="./GenerateRecoveryCodes" class="btn-primary-modern">バックアップコードを再生成</a>
                </div>
            }

            <div class="form-field">
                <label>Authenticator アプリ</label>
                <div class="form-actions">
                    @if (!Model.HasAuthenticator)
                    {
                        <a id="enable-authenticator" asp-page="./EnableAuthenticator" class="btn-primary-modern">Authenticator を追加</a>
                    }
                    else
                    {
                        <a id="enable-authenticator" asp-page="./EnableAuthenticator" class="btn-primary-modern">Authenticator を再設定</a>
                        <a id="reset-authenticator" asp-page="./ResetAuthenticator" class="btn-outline">Authenticator をリセット</a>
                    }
                </div>
            </div>

            @if (!Model.Is2faEnabled)
            {
                <p class="hint-text">2段階認証はまだ有効化されていません。Authenticator アプリを設定し、有効化してください。</p>
            }
        }
    }
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
